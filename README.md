# WebPanel

___

## Содержание:

---

- [Описание проекта](#описание-проекта)
- [Стек технологий](#стек-технологий)
  - [Для пользователей](#для-пользователей)
    - [Как запустить](#как-запустить)
- [Контакты](#контакты)
- [Документация](#документация)
- [Лицензия](#лицензия)

___

## Описание проекта

---

**WebPanel** — это веб-приложение, разработанное на Flask, 
созданное с целью демонстрации навыков работы с современными веб-технологиями.

Проект служит примером качественной архитектуры, 
интеграции с базами данных, автоматизации CI/CD и 
организации кода с применением лучших практик разработки.
___

## Стек технологий

---

- **Flask** — веб-фреймворк для серверного приложения.
- **SQLAlchemy** — ORM для работы с базой данных PostgreSQL.
- **Makefile** — инструмент для автоматизации команд.
- **Poetry** — управление зависимостями Python.
- **Docker** — контейнеризация проекта.
- **pytest** — тестирование.
- **Sphinx** — генерация документации.
- **Swagger** 

### Документирование
Для автогенерации документации используется:

 - **Sphinx** — инструмент для создания и управления документацией.

### Статический анализ кода
В проекте применяются следующие инструменты для проверки качества кода:

 - **black** — автоформатирование кода в соответствии с PEP 8.
 - **flake8** — анализатор кода на соответствие стандартам и поиск ошибок.
 - **isort** — автоупорядочивание импортов.
 - **mypy** — проверка статической типизации.
 - **bandit** — анализатор безопасности кода.

### Логирование
Для работы с логами используется:

 - **Loki** — система для сбора, хранения и анализа логов (prod).
 - **logging** — встроенный модуль Python для логирования (dev).
 - **Promtail** — агент сбора логов для Loki.

### Тестирование
Процесс тестирования обеспечивается следующими инструментами:

 - pytest — основная библиотека для тестирования.
 - pytest-flask — плагин для интеграционного тестирования Flask-приложений.
 - pytest-mock — удобный инструмент для работы с мока-объектами.
 - allure — инструмент для генерации отчетов о тестировании.
 - coverage.py — анализ покрытия тестами.

___

## Для разработчиков

---

Этот раздел предназначен для разработчиков. Здесь описаны структура проекта, 
предназначение папок и файлов, а также инструкции по запуску и базовая информация о проекте

### Базовая структура проекта

---

```
├── docs
│   ├── _build
│   ├── conf.py
│   ├── index.rst
│   └── modules.rst
├── k3s
│   ├── helm
│   ├── manifests
│   ├── network-policy
│   ├── k3d-cluster.yaml
│   └── README.md
├── migrations
│   ├── versions
│   ├── alembic.ini
│   ├── env.py
│   ├── README
│   ├── script.py.mako
├── shell
│   ├── send_allure.sh
├── config
│   ├── db_config
│   ├── logger_filters
│   ├── app_config.toml
│   ├── logging_config_dev.yaml
│   ├── logging_config_prod.yaml
│   ├── loki-config.yaml
│   └── promtail-config.yaml
├── src
│   ├── app
│   │   ├── core
│   │   │   ├── di
│   │   │   ├── config.py
│   │   │   └── context_processors.py
│   │   ├── controllers
│   │   ├── db
│   │   ├── repository
│   │   ├── schemas
│   │   ├── utils
│   │   ├──  views
│   │   └── run.py
│   └── tests
│       ├── blueprint
│       ├── integ
│       ├── e2e
│       ├── unit
│       └── conftest.py
├── docker-compose.yaml
├── docker-compose-dev-logs.yaml
├── Dockerfile
├── Makefile
├── LICENSE
├── README.md
├── .pre-commit-config.yaml
├── pyproject.toml
└── poetry.lock
```

### Описание папок и файлов

- docs – папка для хранения генерируемой документации.
  - docs/_build – директория с сгенерированными данными для автодокументирования.
  - docs/conf.py – конфигурационный файл для автодокументирования.
  - docs/index.rst – главная страница документации.
  docs/modules.rst – описание подключаемых модулей документации.
- config – конфигурационные файлы приложения.
  - config/logger_filters – папка с фильтрами для логгера.
  - config/app_config.toml – статическая конфигурация приложения.
  - config/logging_config_dev.yaml – конфигурация логгера для разработки.
  - config/logging_config_prod.yaml – конфигурация логгера для продакшн-среды.
  - config/loki-config.yaml – конфигурация для Loki.
  - config/promtail-config.yaml – конфигурация для сбора метрик через Promtail.
- src – исходный код приложения и тесты.
  - src/app – основная логика приложения.
    - src/app/core – модуль для базовой логики приложения.
      - src/app/core/di – папка с DI-контейнерами приложения.
      - src/app/core/config.py – файл для загрузки конфигурации приложения.
    - src/db - модуль для работы с базой данных 
    - src/schemas - модуль схем для контролеров (валидация данных)
    - src/app/context_processors.py – файл для подключения маршрутов в динамическом режиме.
    - src/app/controllers – модуль с контроллерами приложения.
    - src/app/repository – модуль с интерфейсами и реализациями репозиториев.
    - src/app/utils – вспомогательные функции приложения.
    - src/app/views – модуль с представлениями, организованными по blueprint.
  - src/test – директория с тестами для приложения.
    - src/test/blueprint – тесты для blueprint.
    - src/test/db – тесты для базы данных.
    - src/test/e2e – тесты end to end.
    - src/test/integration – интеграционные тесты.
    - src/test/unit – модульные тесты.
    - src/test/conftest.py – конфигурация для тестирования.
  - run.py - точка входа в приложение
- docker-compose-dev-logs.yaml – файл Docker Compose для поднятия среды разработки(prod).
- docker-compose.yaml – файл Docker Compose для поднятия среды разработки(dev).
- Dockerfile – файл для сборки приложения в контейнере.
- Makefile – конфигурационный файл для автоматизации локальной разработки.
- LICENSE – файл лицензии проекта.
- README.md – файл описания проекта.
- .pre-commit-config.yaml – конфигурация для проверки кода перед коммитом.
- pyproject.toml – файл зависимостей для Poetry.
- poetry.lock – файл с зафиксированными зависимостями.

## Начало работы

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/DarkAlastor/FlaskWebPanelSSL.git
   ```
2. Перейдите в директорию проекта:
   ```bash
   cd FlaskWebPanelSSL
   ```
3. Установите зависимости:
   ```bash
   make install
   ```
   
4. Активируйте виртуальное окружение командой:
    ```commandline
    poetry shell
    ```

5. После установки зависимостей, вы можете запустить проект в режиме разработки, 
используя Docker Compose данный файл поднимет все необходимое окружения:
    ```commandline
    docker-compose up -d
    ```

Теперь вы можете начать работу с проектом.

#### Некоторые проблемы с Poetry: 
1) Если каким-то образом tox заменил ваше виртуальное окуржение вот решение:
```
# Удалите окурежние:
poetry env remove python
# Диактивируйте если вы в нем находитесь
deactivate
# Почистите артифкаты :
rm -rf ~/.cache/pypoetry/artifacts/*
#Далее создайте новое окуржение:
poetry env use python3.10
# Почистите артифкаты если нужно:
rm -rf ~/.cache/pypoetry/artifacts/*
# Далее активируем окуржение 
poetry shell
# Кстанавлиавем зависимости командой
poetry install -vvv
```
2) Может быть проблема с keyring если есть бескоенчная загрузка зависимостей
```
# Исполльзуйте в вирутальном окружение терминале вот эту команду 
export PYTHON_KEYRING_BACKEND=keyring.backends.null.Keyring
# Переактивируйте окружение 
poetry shell
# Выполните установку
poetry install -vvv
```

Теперь вам необходимо настроить файл .env с переменными окружениями 

Пример файла .env 

```
# Корень проекта
PROJECT_ROOT=/home/darkalastor/PycharmProjects/FlaskWebPanelSSL

# Настройки Allure
ALLURE_HOST="http://localhost:5051"                           # Хост сервиса Allure Docker Service
PROJECT_ID="web-panel-ssl"                                    # Идентификатор проекта в Allure
SEND_PATH="/allure-docker-service/send-results"               # Путь для отправки результатов тестов
GENERATE_PATH="/allure-docker-service/generate-report"        # Путь для генерации отчёта Allure

# Настройки Flask
FLASK_APP=src/app/run.py                                      # Точка входа для запуска приложения Flask
FLASK_STATUS_DEBUG=true                                       # Включение режима отладки (true для разработки)
FLASK_STATUS_TESTING=true                                     # Включение тестового режима (true для тестов)
FLASK_STATUS_PROD_STAGES=false                                # Указание режима продакшена (false для разработки)
FLASK_WTF_CSRF_ENABLED=false                                  # Включение/отключение CSRF-защиты (false для тестов)

# Секретные ключи Flask
FLASK_SECRET_KEY_SESSION='default_secret_key_session'         # Ключ для подписания сессий
FLASK_SECRET_KEY_FALLBACKS=None                               # Резервный ключ для подписания сессий

# Настройки базы данных
FLASK_SQLALCHEMY_DATABASE_URI="postgresql://web_panel_user:web_panel_password@localhost:5432/web_panel_ssl_db"
                                                             # URI подключения к основной базе данных
FLASK_SESSION_REDIS_URI="redis://localhost:6379/0"           # URI подключения к базе Redis для хранения сессий

# Путь к конфигурации приложения
FLASK_CONFIG_PATH="config/app_config.toml"                   # Путь к файлу конфигурации приложения
```
___

## Некоторые базовые команды Makefile

---

### **Форматирование и проверка кода**

#### **Форматирование кода (Black, isort)**  
Для приведения кода к единому стилю выполните:  

```commandline
make formater
```

Эта команда выполнит:
- **`black`** — автоформатирование кода согласно стандарту PEP 8.
- **`isort`** — автоматическую сортировку импортов.

---

#### **Запуск линтеров**  
В проекте используются следующие инструменты для проверки кода:
- **flake8** (анализатор на соответствие стандартам PEP 8)  

Для проверки кода выполните:  
```commandline
make lint
```
Эта команда запустит **flake8** и покажет найденные ошибки стиля и потенциальные баги.

---

#### **Проверка типов (mypy)**  
Для статической проверки типов используйте команду:  
```commandline
make typecheck
```

Эта команда выполнит:
- **`mypy`** — анализ типов в коде, предотвращая потенциальные ошибки.

---

#### **Проверка безопасности кода (Bandit)**  
Для выявления уязвимостей в коде выполните команду:  
```commandline
make security
```
Эта команда запускает **Bandit**, который анализирует код на предмет возможных проблем безопасности.

---

### **Генерация документации**  

В проекте используется **Sphinx** для автоматического создания документации.

#### **Генерация API-документации**  
```commandline
make apidoc
```
Эта команда создаст документацию по кодовым комментариям (docstrings) в `docs/`.

#### **Генерация HTML-документации**  
```commandline
make docs
```
Эта команда соберёт документацию в `docs/_build/html`.

#### **Запуск локального сервера документации**  
```commandline
make start-docs
```
Открывает локальный HTTP-сервер для просмотра документации.

---

### **Тестирование**  
В проекте используются **pytest** и **coverage** для тестирования.

#### **Запуск всех тестов**  
```commandline
make test-all
```
Запускает **все тесты** проекта.

#### **Запуск отдельных типов тестов**  
- **Юнит-тесты**:
  ```commandline
  make unit-tests
  ```
- **E2E (end-to-end) тесты**:
  ```commandline
  make e2e-tests
  ```
- **Интеграционные тесты**:
  ```commandline
  make integ-tests
  ```
- **Тесты для Blueprints**:
  ```commandline
  make blueprints-tests
  ```

#### **Измерение покрытия тестами**  
```commandline
make coverage
```
- Запускает **coverage.py** для измерения покрытия тестами.
- Генерирует отчёт о покрытии.

---

### **Миграции базы данных**  
В проекте используется **Flask-Migrate** для управления схемой базы данных.

#### **Инициализация миграций**  
```commandline
make db-init
```
Создаёт директорию миграций.

#### **Создание новой миграции**  
```commandline
make db-migrate
```
Автоматически определяет изменения в моделях и создаёт миграцию.


#### **Применение миграций**  
```commandline
make db-upgrade
```
Применяет все неопубликованные миграции к базе данных.

---

### **Сборка Docker-контейнера**  
В проекте используется **Docker** для контейнеризации.

#### **Сборка контейнера для разработки**  
```commandline
make build-dev
```
Эта команда создаёт **Docker-образ** с тегом `flask-web-panel:dev`.



## Документация

- https://darkalastor.github.io/WebPanel/

## Контакты
- Telegram: @krash_i

## Лицензия
Проект лицензирован под [BSD-2-Clause license](https://opensource.org/licenses/BSD-2-Clause).
